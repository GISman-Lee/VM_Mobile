<!doctype html>
<html ng-app = "VM_Mobile2">
<head>
  <style>
     #search
     {
        position:  absolute;
        z-index: 1;
        display: block;
        top: 30px;
        margin-left: 20px;
        float: right;
    }

    .mblListItemLayoutLeft {position: relative; float: left; margin-right: 11px;}
    .mblListItemLayoutRight {position: relative; float: right;}
    .mblListItem {position: relative; overflow: hidden; padding: 0 8px; height: 43px; list-style-type: none; line-height: 43px; -webkit-tap-highlight-color: rgba(255, 255, 255, 0); border-bottom: 1px solid #adaaad; font-weight: bold; color: black;}
</style>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- On iOS, as part of optimizing your web application, have it use the
    standalone mode to look more like a native application. When you use this
    standalone mode, Safari is not used to display the web contentâ€”specifically,
    there is no browser URL text field at the top of the screen or button bar
    at the bottom of the screen. -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Controls the dimensions and scaling of the browser window in iOS,
    Android, webOS, Opera Mini, Opera Mobile and Blackberry. width: controls
    the width of the viewport initial-scale: controls the zoom level when the
    page is first loaded maximum-scale: control how users are allowed to zoom
    the page in or out user-scalable: control how users are allowed to zoom
    the page in or out -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Sets the style of the status bar for a web application when in standalone
    mode -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Vehicle Management - Mobile</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/esri/css/esri.css">
    <!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">-->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet" >
    <link rel="stylesheet" href="bootstrap/css/bootstrap-responsive.css">

    <script>var dojoConfig = { mblAlwaysHideAddressBar: true };</script>
    <script src="http://js.arcgis.com/3.9compact/"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.17/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.17/angular-route.min.js"></script>
    <script src="Js/panel.js"></script>
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- <script src="http://gmaps-utility-gis.googlecode.com/svn/trunk/gmapslayer/src/gmapslayer.js"></Script> -->
    <!--  <script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>  -->
    <!--  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.1.min.js"></script> -->

    <script>
      require(["esri/map", "dojox/mobile", "dojox/mobile/parser", "esri/sniff",
        "dojox/mobile/deviceTheme", "dojo/dom", "dijit/registry", "dojo/on",
        "dojox/mobile/ToolBarButton", "dojox/mobile/View", "dojox/mobile/ContentPane"],

        function (Map, mobile, parser, has, dTheme, dom, registry, on) {
          parser.parse();
          mobile.hideAddressBar();

          map = new esri.Map("map", {
            basemap: "osm",
            center: [151.209900, -33.865143],
            zoom: 10,
            slider: false
        });
          //osmLayer = new esri.layers.OpenStreetMapLayer();
          //map.addLayer(osmLayer);
          //gMapLayer = new gmaps.GoogleMapsLayer({ visible: true, id: 'googlemaps' });
          //map.addLayer(gMapLayer);

      });
  </script>
</head>

<body>

  <script>
    function OnloadCallBack(){
      esri.config.defaults.io.corsEnabledServers.push("120.151.95.114:8080");
      SubjectGraphicsLayer = new esri.layers.GraphicsLayer({
        "id": "subject_graphics",
    });

      LocationGraphicsLayer = new esri.layers.GraphicsLayer({
        "id": "location_graphics"
    });

      map.addLayer(SubjectGraphicsLayer);
      map.addLayer(LocationGraphicsLayer);

      dojo.connect(SubjectGraphicsLayer.graphics, "onClick", function(evt) {  //"onMouseMove"
          var g = evt.graphic;
          map.infoWindow.setContent(g.getContent());
          map.infoWindow.setTitle("Device Infomation");
          map.infoWindow.show(evt.screenPoint,map.getInfoWindowAnchor(evt.screenPoint));
      });

      setInterval( "QueryData()", 10000 );
    }

      function addPointToMap(entry) {
            //var point = new esri.geometry.Point(lon,lat);
            //point = esri.geometry.geographicToWebMercator(point);

            var template = new esri.InfoTemplate(
             "Device Information",
             "<h4>Device ID: </h4>" + entry.Did + "<br>" +
             "<h4>Subject Name: </h4>" + entry.BusinessName +"<br>" +
             "<h4>Time: </h4>" + Date(parseInt(entry.Time)).toString()
             )

            SubjectGraphicsLayer.add(

              new esri.Graphic(
                    //point,
                    new esri.geometry.Point(entry.Longitude, entry.Latitude, new esri.SpatialReference({ wkid:4326 })),  //the  original third parameter --> map.spatialReference wkid:4326
                    //new esri.symbol.SimpleMarkerSymbol().setColor(new dojo.Color([255,0,0,0.5]))
                    new esri.symbol.PictureMarkerSymbol('images/DeviceType' + entry.SubjectType.toString() +'/number_'+ entry.Id.toString() +'.png',25,25),
                    null,
                    template
                    )
              );


        }

        function QueryData(){
            var MyQuery = esri.request({
               url:  "http://120.151.95.114:8080/Projects/Services/GPSServices.svc/GetTrackerDevCrossTable",  //"http://120.151.95.114:8080/GPSServices.svc/GetTrackerDevCrossTable", //"data/test2.json",
               handleAs: "json",
               //callbackParamName: "jsoncallback"
           });
            MyQuery.then(requestSucceeded, requestFailed);
        }

        function requestSucceeded(data) {
            //var jsonData = JSON.parse(data);

            SubjectGraphicsLayer.clear();
            //map.graphics.clear();
            data.forEach(function(entry){
               addPointToMap(entry);
           });

            console.log("Data: ", data); // print the data to browser's console
        }

        function requestFailed(error) {
            console.log("Error: ", error.message);
        }

        dojo.ready(OnloadCallBack);
        //contentDivHeight = $("#mapView").height();contentDivWidth = $("#mapView").width(); alert(contentDivHeight.toString());
    </script>

    <script>
        require([
           "esri/map",
           "esri/dijit/Geocoder",
           "esri/graphic",
           "esri/symbols/SimpleMarkerSymbol",
           "esri/geometry/screenUtils",
           "dojo/dom",
           "dojo/dom-construct",
           "dojo/query",
           "dojo/_base/Color",
           "dojo/domReady!"
           ], function ( Map, Geocoder, Graphic, SimpleMarkerSymbol, screenUtils, dom, domConstruct, query, Color) {
             var geocoder = new Geocoder({
               autoComplete: true,
               map: map,
               arcgisGeocoder: {
                  placeholder: "Find a place"
              },
          }, dom.byId("search"));

             geocoder.on("select", showLocation);

             function showLocation(evt) {
                LocationGraphicsLayer.clear();
                var point = evt.result.feature.geometry;
                var symbol = new SimpleMarkerSymbol().setStyle("square").setColor(new Color([255,0,0,0.5]));
                var graphic = new Graphic(point, symbol);
                LocationGraphicsLayer.add(graphic);
                map.infoWindow.setTitle("Search Result");
                map.infoWindow.setContent(evt.result.name);
                map.infoWindow.show(evt.result.feature.geometry);
            }

            geocoder.startup();
        });
</script>

<div id="header" data-dojo-type="dojox.mobile.Heading">
    Vehicle Management by SR Constructions
</div>
<div class="container-fluid">
  <div class="row-fluid">
      <div class="span9">
          <div id="mapView" data-dojo-type="dojox.mobile.View" data-dojo-props="selected: true">
            <div id="mapContainer" data-dojo-type="dojox.mobile.ContentPane">
                <div id="map" style="margin-top: 7px; min-height: 1024px;"></div>
                <div id="search"></div>
            </div>
        </div>
    </div>

    <div class="span3">
      <div id="aboutView" data-dojo-type="dojox.mobile.View" ng-controller="PanelCtrl" style="display:none" >
          <ul data-dojo-type="dojox/mobile/RoundRectList" style="margin-right: 0px;">
            <li data-dojo-type="dojox/mobile/ListItem"  class="mblListItem" ng-repeat = "dev in DevInfos">
             <div class="mblListItemLayoutLeft">{{dev.BusinessName}}</div>
             <div class="mblListItemLayoutRight"><img src="images/DeviceType{{dev.SubjectType}}/number_{{dev.Id}}.png" alt="Smiley face" height="22" width="22"></div>
         </li>
     </ul>
 </div>
</div>


</div>
</div>
</body>
</html>
