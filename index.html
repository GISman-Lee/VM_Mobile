<!doctype html>
<html ng-app = "MapCtrl">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- On iOS, as part of optimizing your web application, have it use the
    standalone mode to look more like a native application. When you use this
    standalone mode, Safari is not used to display the web contentâ€”specifically,
    there is no browser URL text field at the top of the screen or button bar
    at the bottom of the screen. -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Controls the dimensions and scaling of the browser window in iOS,
    Android, webOS, Opera Mini, Opera Mobile and Blackberry. width: controls
    the width of the viewport initial-scale: controls the zoom level when the
    page is first loaded maximum-scale: control how users are allowed to zoom
    the page in or out user-scalable: control how users are allowed to zoom
    the page in or out -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- Sets the style of the status bar for a web application when in standalone
    mode -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Getting Started - Mobile</title>

    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/esri/css/esri.css">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">

    <script>var dojoConfig = { mblAlwaysHideAddressBar: true };</script>
    <script src="http://js.arcgis.com/3.9compact/"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.17/angular.min.js"></script>
    <script>
    require(["esri/map", "dojox/mobile", "dojox/mobile/parser", "esri/sniff", 
            "dojox/mobile/deviceTheme", "dojo/dom", "dijit/registry", "dojo/on", 
            "dojox/mobile/ToolBarButton", "dojox/mobile/View", "dojox/mobile/ContentPane"],
      
      function(Map, mobile, parser, has, dTheme, dom, registry, on) {
        parser.parse();
        mobile.hideAddressBar();

          map = new esri.Map("map", {
          basemap: "topo",
          center: [151.209900, -33.865143],
          zoom: 10,
          slider: false
        });
        map.on("load", mapLoadHandler);

        var resizeEvt = (window.onorientationchange !== undefined && !has('android')) ? "orientationchange" : "resize";
        on(window, resizeEvt, resizeMap);

        function mapLoadHandler(evt) {
          resizeMap();
          registry.byId('mapView').on('AfterTransitionIn', resizeMap);
        }

        function resizeMap() {
          mobile.hideAddressBar();
          adjustMapHeight();
          map.resize();
          map.reposition();
        }

        function adjustMapHeight() {
          var availHeight = mobile.getScreenSize().h - registry.byId('header').domNode.clientHeight - 1;
          if (has('iphone') || has('ipod')) {
            availHeight += iphoneAdjustment();
          }
          dom.byId("map").style.height = availHeight + "px";
        }

        function iphoneAdjustment() {
          var sz = mobile.getScreenSize();
          if (sz.h > sz.w) { //portrait
            //Need to add address bar height back to map
             return screen.availHeight - window.innerHeight - 40; /* 40 = height of bottom safari toolbar */
          } else { //landscape
            //Need to react to full screen / bottom bar visible toggles
            var _conn = on(window, 'resize', function() {
              _conn.remove();
              resizeMap();
            });
            return 0;
          }
        }

      });
    </script>
  </head>
  
  <body>
    
    <script>
        function OnloadCallBack(){
            esri.config.defaults.io.corsEnabledServers.push("120.151.95.114:8080");
            SubjectGraphicsLayer = new esri.layers.GraphicsLayer({ 
                  "id": "subject_graphics", 
            });
             
            map.addLayer(SubjectGraphicsLayer);
            dojo.connect(SubjectGraphicsLayer.graphics, "onMouseEnter", function(evt) {  //"onMouseMove"
               var g = evt.graphic;
               map.infoWindow.setContent(g.getContent());
               map.infoWindow.setTitle("Device Infomation");
               map.infoWindow.show(evt.screenPoint,map.getInfoWindowAnchor(evt.screenPoint));
            });
            dojo.connect(SubjectGraphicsLayer.graphics, "onMouseLeave", function() {map.infoWindow.hide();} );

            setInterval( "QueryData()", 10000 );
        }

        function addPointToMap(entry) { 
            //var point = new esri.geometry.Point(lon,lat);
            //point = esri.geometry.geographicToWebMercator(point);
    
            var template = new esri.InfoTemplate(
               "Device Information", 
               "<h4>Device ID: </h4>" + entry.Did + "<br>" + 
               "<h4>Subject Name: </h4>" + entry.BusinessName +"<br>" +
              "<h4>Time: </h4>" + Date(parseInt(entry.Time)).toString()
            )

            SubjectGraphicsLayer.add(

                new esri.Graphic(
                    //point, 
                    new esri.geometry.Point(entry.Longitude, entry.Latitude, new esri.SpatialReference({ wkid:4326 })),  //the  original third parameter --> map.spatialReference
                    //new esri.symbol.SimpleMarkerSymbol().setColor(new dojo.Color([255,0,0,0.5]))
                    new esri.symbol.PictureMarkerSymbol('images/DeviceType' + entry.SubjectType.toString() +'/number_'+ entry.Id.toString() +'.png',25,25),
                    null,
                    template
                )
            );


        }
  
        function QueryData(){ 
            var MyQuery = esri.request({
               url:  "http://120.151.95.114:8080/GPSServices.svc/GetTrackerDevCrossTable", //"data/test2.json", 
               handleAs: "json",
               //callbackParamName: "jsoncallback"
            });
            MyQuery.then(requestSucceeded, requestFailed);
        }
  
        function requestSucceeded(data) {
            //var jsonData = JSON.parse(data);

            SubjectGraphicsLayer.clear();     
            //map.graphics.clear();
            data.forEach(function(entry){
               addPointToMap(entry); 
            });

            console.log("Data: ", data); // print the data to browser's console
        }

        function requestFailed(error) {
            console.log("Error: ", error.message);
        }

        dojo.ready(OnloadCallBack);
    </script>

    <div id="mapView" data-dojo-type="dojox.mobile.View" data-dojo-props="selected: true">
      <div id="header" data-dojo-type="dojox.mobile.Heading">
        <div id="aboutButton" data-dojo-type="dojox.mobile.ToolBarButton" style="float: right;" moveTo="aboutView">Device Panel</div>
      </div>
      <div id="mapContainer" data-dojo-type="dojox.mobile.ContentPane">
        <div id="map"></div>
      </div>
    </div>

    <div id="aboutView" data-dojo-type="dojox.mobile.View">
      <h1 data-dojo-type="dojox.mobile.Heading" data-dojo-props="back:'Map', moveTo:'mapView'">Device Panel</h1>
      <p style="padding: 5px;">This area can contain additional information about your application.</p>
 
    </div>
  </body>
</html>
